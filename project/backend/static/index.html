<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IVR Call Simulator â€” Royal Purple</title>
  <style>
    /* (same CSS you already had; kept compact here for brevity) */
    :root{
      --bg-grad: linear-gradient(135deg,#2b0037 0%, #5b1aa0 40%, #ff6ec7 100%);
      --panel: rgba(255,255,255,0.06);
      --glass: rgba(255,255,255,0.04);
      --accent: #d6a2ff;
      --accent-2: #ff8ad1;
      --muted: rgba(255,255,255,0.75);
      --success: #6ef1c7;
      --danger: #ff7b8a;
      --shadow: 0 10px 30px rgba(11,3,20,0.6);
      --radius: 18px;
      --transition: 240ms cubic-bezier(.2,.9,.3,1);
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;background: var(--bg-grad);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
    .device{width:100%;max-width:920px;display:grid;grid-template-columns:1fr 360px;gap:22px;align-items:start}
    .phone{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;min-height:560px;display:flex;flex-direction:column;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#5b1aa0,#ff6ec7);display:grid;place-items:center;color:white;font-weight:700;font-size:18px}
    .title{color:var(--muted);font-size:14px}
    .subtitle{color:rgba(255,255,255,0.5);font-size:12px;margin-top:4px}
    .status-pill{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
    .status-icon{font-size:20px}.status-text{color:var(--accent);font-weight:700;font-size:13px;text-transform:uppercase;letter-spacing:0.9px}
    .screen{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;margin-top:8px;flex:1;display:flex;flex-direction:column;gap:14px;border:1px solid rgba(255,255,255,0.025)}
    .call-info{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .caller{display:flex;flex-direction:column}
    .caller-number{color:white;font-weight:700;font-size:18px;letter-spacing:0.6px}
    .call-duration{color:var(--accent);font-weight:600;font-size:13px;margin-top:6px}
    .speaker-box{width:88px;height:88px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:grid;place-items:center;border:1px solid rgba(255,255,255,0.02)}
    .ivr{background:var(--glass);border-radius:12px;padding:14px;min-height:160px;max-height:240px;overflow:auto;border:1px solid rgba(255,255,255,0.02)}
    .ivr p{margin-bottom:10px;color:#fff;opacity:0.95;line-height:1.45}
    .keypad{display:grid;grid-template-columns:repeat(3,64px);gap:12px}
    .key{width:64px;height:64px;border-radius:12px;display:flex;flex-direction:column;justify-content:center;align-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:white;user-select:none}
    .key.disabled{opacity:0.45;pointer-events:none}
    .actions{display:flex;gap:12px;margin-left:auto}
    .btn{padding:12px 14px;border-radius:12px;font-weight:700;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:8px;justify-content:center}
    .btn.call{background:linear-gradient(90deg,#b06bff,#ff7bd6);color:#1a0424}
    .btn.hang{background:linear-gradient(90deg,#ff6b6b,#ff9c9c);color:#fff}
    .side{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.02);height:560px;display:flex;flex-direction:column;gap:12px}
    @media (max-width:920px){.device{grid-template-columns:1fr}.side{height:auto;order:2}.phone{order:1}}
  </style>
</head>
<body>
  <div class="device">
    <div class="phone" aria-live="polite">
      <div class="header">
        <div class="brand">
          <div class="logo">AI</div>
          <div>
            <div class="title">Air India â€” IVR Simulator</div>
            <div class="subtitle">Simulated call & DTMF flow</div>
          </div>
        </div>
        <div class="status-pill" aria-hidden="false">
          <div id="statusIcon" class="status-icon">ðŸ“ž</div>
          <div id="statusText" class="status-text">Ready to Call</div>
        </div>
      </div>

      <div class="screen">
        <div class="call-info">
          <div class="caller">
            <div class="caller-number">+91 1800-123-456</div>
            <div id="callDuration" class="call-duration">00:00</div>
          </div>
          <div class="speaker-box"><div class="speaker-emoji">ðŸŽ§</div></div>
        </div>

        <div id="ivrOutput" class="ivr" aria-atomic="true">
          <p class="note">Press <strong>Start Call</strong> to begin...</p>
        </div>

        <div class="controls">
          <div id="keypad" class="keypad" aria-hidden="true">
            <div class="key" data-key="1"><div class="num">1</div></div>
            <div class="key" data-key="2"><div class="num">2</div><div class="letters">ABC</div></div>
            <div class="key" data-key="3"><div class="num">3</div><div class="letters">DEF</div></div>
            <div class="key" data-key="4"><div class="num">4</div><div class="letters">GHI</div></div>
            <div class="key" data-key="5"><div class="num">5</div><div class="letters">JKL</div></div>
            <div class="key" data-key="6"><div class="num">6</div><div class="letters">MNO</div></div>
            <div class="key" data-key="7"><div class="num">7</div><div class="letters">PQRS</div></div>
            <div class="key" data-key="8"><div class="num">8</div><div class="letters">TUV</div></div>
            <div class="key" data-key="9"><div class="num">9</div><div class="letters">WXYZ</div></div>
            <div class="key" data-key="*"><div class="num">*</div></div>
            <div class="key" data-key="0"><div class="num">0</div><div class="letters">+</div></div>
            <div class="key" data-key="#"><div class="num">#</div></div>
          </div>

          <div class="actions">
            <button id="btnCall" class="btn call">ðŸ“ž Start Call</button>
            <button id="btnHangup" class="btn hang" disabled>ðŸ“µ Hang Up</button>
          </div>
        </div>
      </div>
    </div>

    <aside class="side" aria-label="Call history and options">
      <h4>Call Log</h4>
      <div id="callHistory" class="history"><div class="entry">No calls yet</div></div>
      <div class="small">Tip: Use keypad while call is active to navigate IVR. Press 9 to transfer to agent.</div>
    </aside>
  </div>

<script>
/* ---------- Configuration ----------
   We call relative endpoints so this will work when static is served by the same backend.
   If you host frontend separately, set BACKEND_BASE to the backend full URL (no trailing slash).
*/
const BACKEND_BASE = ""; // leave blank so fetch('/ivr') => same origin

/* Elements */
const btnCall = document.getElementById('btnCall');
const btnHang = document.getElementById('btnHangup');
const keypad = document.getElementById('keypad');
const keys = Array.from(document.querySelectorAll('.key'));
const ivrOutput = document.getElementById('ivrOutput');
const callHistory = document.getElementById('callHistory');
const statusIcon = document.getElementById('statusIcon');
const statusText = document.getElementById('statusText');
const callDurationEl = document.getElementById('callDuration');

let callActive = false;
let callStart = null;
let durationTimer = null;
let historyArr = [];
let frontendCallSid = null;

/* Utilities */
const wait = ms => new Promise(r => setTimeout(r, ms));
function appendIVR(text){ const p = document.createElement('p'); p.textContent = text; ivrOutput.appendChild(p); ivrOutput.scrollTop = ivrOutput.scrollHeight; }
function addLog(type, status){ const time = new Date().toLocaleTimeString(); historyArr.unshift(`${time} - ${type} - ${status}`); renderHistory(); }
function renderHistory(){ callHistory.innerHTML = historyArr.length ? historyArr.slice(0,20).map(h => `<div class="entry">${h}</div>`).join('') : '<div class="entry">No calls yet</div>'; }
function enableKeypad(enabled){ keys.forEach(k => enabled ? k.classList.remove('disabled') : k.classList.add('disabled')); keypad.setAttribute('aria-hidden', !enabled); }
function setStatus(icon, text){ statusIcon.textContent = icon; statusText.textContent = text; }

/* Duration */
function startDuration(){ callStart = Date.now(); durationTimer = setInterval(()=>{ const s=Math.floor((Date.now()-callStart)/1000); const m=String(Math.floor(s/60)).padStart(2,'0'); const sec=String(s%60).padStart(2,'0'); callDurationEl.textContent = `${m}:${sec}`; },1000); }
function stopDuration(){ clearInterval(durationTimer); durationTimer=null; }

/* Simple beep */
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
function playBeep(){ try{ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.value=800; g.gain.value=0.02; o.connect(g); g.connect(audioCtx.destination); o.start(); setTimeout(()=>o.stop(),120);}catch(e){} }

/* Local welcome text (visual) */
async function playWelcome(){
  appendIVR('ðŸ”Š Welcome to Air India Airlines Customer Support.');
  await wait(500);
  appendIVR('ðŸ”Š Press 1 for Booking Enquiry.');
  await wait(300);
  appendIVR('ðŸ”Š Press 2 for Flight Status.');
  await wait(300);
  appendIVR('ðŸ”Š Press 9 to speak with an agent.');
}

/* Backend calls (Twilio-like) */
async function fetchIVRFromBackend(){
  try{
    appendIVR('Calling backend /ivr...');
    frontendCallSid = frontendCallSid || `FE_${Date.now()}`;
    const fd = new FormData(); fd.append('CallSid', frontendCallSid);
    const res = await fetch(`${BACKEND_BASE}/ivr`, { method: 'POST', body: fd });
    if (!res.ok){ appendIVR(`Backend /ivr returned ${res.status}`); return; }
    const text = await res.text();
    // try to parse TwiML <Say> occurrences
    if (text.trim().startsWith('<')){
      const parser = new DOMParser();
      const doc = parser.parseFromString(text,'text/xml');
      const says = Array.from(doc.querySelectorAll('Say')).map(s=>s.textContent.trim()).filter(Boolean);
      if (says.length) says.forEach(s => appendIVR(`Backend: ${s}`));
      else appendIVR(`Backend XML: ${text}`);
    } else {
      appendIVR(`Backend: ${text}`);
    }
  }catch(e){ appendIVR(`Backend error: ${e.message}`); console.error(e); }
}

async function sendKeyToBackend(digit){
  try{
    frontendCallSid = frontendCallSid || `FE_${Date.now()}`;
    const fd = new FormData(); fd.append('CallSid', frontendCallSid); fd.append('Digits', digit);
    const res = await fetch(`${BACKEND_BASE}/handle-key`, { method: 'POST', body: fd });
    if (!res.ok){ appendIVR(`/handle-key returned ${res.status}`); return; }
    const text = await res.text();
    if (text.trim().startsWith('<')){
      const doc = new DOMParser().parseFromString(text,'text/xml');
      const says = Array.from(doc.querySelectorAll('Say')).map(s=>s.textContent.trim()).filter(Boolean);
      if (says.length) says.forEach(s => appendIVR(`Backend: ${s}`));
      else appendIVR(`Backend XML: ${text}`);
    } else {
      appendIVR(`/handle-key: ${text}`);
    }
  }catch(e){ appendIVR(`Backend error: ${e.message}`); console.error(e); }
}

/* Key press handling */
async function onKeyPress(d){
  if (!callActive) return;
  playBeep();
  appendIVR(`[You pressed: ${d}]`);
  // send to backend so server can handle DTMF if you want
  sendKeyToBackend(d);
}

/* Start / end call */
async function startCall(){
  if (callActive) return;
  try{ if (audioCtx.state === 'suspended') await audioCtx.resume(); }catch(e){}
  callActive = true;
  setStatus('ðŸ“ž','Call Connected');
  btnCall.disabled = true; btnHang.disabled = false;
  enableKeypad(true);
  ivrOutput.innerHTML = '';
  startDuration();
  addLog('Outgoing','Connected');
  frontendCallSid = `FE_${Date.now()}`;
  // fetch initial TwiML from backend to populate IVR (optional)
  await fetchIVRFromBackend();
  // also play local welcome so UI shows something reliably
  await playWelcome();
}

function endCall(){
  if (!callActive) return;
  callActive = false;
  setStatus('ðŸ“µ','Call Ended');
  btnCall.disabled = false; btnHang.disabled = true;
  enableKeypad(false);
  stopDuration();
  addLog('Outgoing','Ended');
  setTimeout(()=>{ setStatus('ðŸ“ž','Ready to Call'); callDurationEl.textContent='00:00'; ivrOutput.innerHTML=`<p class="note">Press <strong>Start Call</strong> to begin...</p>` },1200);
}

/* Wire UI */
btnCall.addEventListener('click', async ()=>{ await startCall(); });
btnHang.addEventListener('click', ()=> endCall());
keys.forEach(k => {
  k.addEventListener('click', ()=> {
    const d = k.getAttribute('data-key');
    onKeyPress(d);
  });
});

/* init */
enableKeypad(false);
renderHistory();

/* keyboard support */
window.addEventListener('keydown', ev => {
  const key = ev.key;
  const valid = ['0','1','2','3','4','5','6','7','8','9','*','#'];
  if (valid.includes(key)) {
    const el = keys.find(x => x.dataset.key === key);
    if (el) el.animate([{transform:'scale(1)'},{transform:'scale(0.98)'},{transform:'scale(1)'}], {duration:150});
    onKeyPress(key);
  } else if (key === 'Enter') {
    if (!callActive) btnCall.click();
  } else if (key === 'Escape') {
    if (callActive) btnHang.click();
  }
});
</script>
</body>
</html>
