<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IVR Call Simulator â€” Royal Purple</title>
  <style>
    :root{
      --bg-grad: linear-gradient(135deg,#2b0037 0%, #5b1aa0 40%, #ff6ec7 100%);
      --panel: rgba(255,255,255,0.06);
      --glass: rgba(255,255,255,0.04);
      --accent: #d6a2ff;
      --accent-2: #ff8ad1;
      --muted: rgba(255,255,255,0.75);
      --success: #6ef1c7;
      --danger: #ff7b8a;
      --shadow: 0 10px 30px rgba(11,3,20,0.6);
      --radius: 18px;
      --transition: 240ms cubic-bezier(.2,.9,.3,1);
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      background: var(--bg-grad);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Shell */
    .device {
      width:100%;
      max-width:920px;
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:22px;
      align-items:start;
    }

    /* Left: phone panel */
    .phone {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:20px;
      min-height:560px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.03);
    }

    .header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }

    .brand {
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo {
      width:44px;height:44px;border-radius:10px;
      background: linear-gradient(135deg,#5b1aa0,#ff6ec7);
      display:grid;place-items:center;color:white;font-weight:700;font-size:18px;
      box-shadow: 0 6px 18px rgba(91,26,160,0.24), inset 0 -4px 12px rgba(0,0,0,0.15);
    }
    .title {
      color:var(--muted);
      font-size:14px;
      line-height:1;
    }
    .subtitle { color: rgba(255,255,255,0.5); font-size:12px; margin-top:4px; }

    .status-pill {
      display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;
      background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
    }
    .status-icon { font-size:20px; }
    .status-text { color:var(--accent); font-weight:700; font-size:13px; text-transform:uppercase; letter-spacing:0.9px; }

    /* Screen area */
    .screen {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:18px;
      margin-top:8px;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:14px;
      border:1px solid rgba(255,255,255,0.025);
    }

    .call-info {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .caller {
      display:flex;flex-direction:column;
    }
    .caller-number { color:white; font-weight:700; font-size:18px; letter-spacing:0.6px; }
    .call-duration { color:var(--accent); font-weight:600; font-size:13px; margin-top:6px; }

    .speaker-box {
      width:88px;height:88px;border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      display:grid;place-items:center;border:1px solid rgba(255,255,255,0.02);
      box-shadow: 0 8px 24px rgba(0,0,0,0.45);
    }
    .speaker-emoji { font-size:34px; filter: drop-shadow(0 6px 12px rgba(0,0,0,0.45)); }

    /* IVR output */
    .ivr {
      background: var(--glass);
      border-radius:12px;
      padding:14px;
      min-height:160px;
      max-height:240px;
      overflow:auto;
      border:1px solid rgba(255,255,255,0.02);
    }
    .ivr p { margin-bottom:10px; color: #fff; opacity:0.95; line-height:1.45; animation:fadeUp .28s ease; }
    .ivr p.note { color: rgba(255,255,255,0.75); opacity:0.9; }

    @keyframes fadeUp { from {opacity:0; transform:translateY(8px)} to {opacity:1; transform:none} }

    .speaking {
      display:flex;gap:6px;align-items:center;justify-content:flex-start;
      margin-top:6px;
    }
    .bar { width:5px; height:14px; background:var(--accent); border-radius:3px; transform-origin:center bottom; animation:voice 0.9s infinite ease-in-out; opacity:0.95; }
    .bar:nth-child(2) { animation-delay:0.08s }
    .bar:nth-child(3) { animation-delay:0.16s }
    .bar:nth-child(4) { animation-delay:0.22s }
    @keyframes voice {
      0%,100% { transform:scaleY(0.45) }
      50% { transform:scaleY(1.6) }
    }
    .speaking.hidden { display:none }

    /* keypad */
    .controls {
      display:flex;
      gap:18px;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
      flex-wrap:wrap;
    }

    .keypad {
      display:grid;
      grid-template-columns: repeat(3,64px);
      gap:12px;
      justify-content:flex-start;
      align-items:center;
    }

    .key {
      width:64px;height:64px;border-radius:12px;
      display:flex;flex-direction:column;justify-content:center;align-items:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
      cursor:pointer; transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
      color:white; user-select:none;
    }
    .key .num { font-size:18px; font-weight:700 }
    .key .letters { font-size:10px; opacity:0.75; margin-top:2px }

    .key:active { transform:translateY(3px) scale(0.99) }
    .key.disabled { opacity:0.45; pointer-events:none; transform:none }

    .actions {
      display:flex; gap:12px; margin-left:auto;
    }
    .btn {
      padding:12px 14px; border-radius:12px; font-weight:700; cursor:pointer;
      border:none; display:inline-flex; align-items:center; gap:8px; justify-content:center;
      transition: transform var(--transition), box-shadow var(--transition);
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    }
    .btn.call {
      background: linear-gradient(90deg, #b06bff, #ff7bd6);
      color: #1a0424; transform-origin:center;
    }
    .btn.hang {
      background: linear-gradient(90deg,#ff6b6b,#ff9c9c);
      color: white;
    }
    .btn:disabled { opacity:0.55; cursor:not-allowed; transform:none; box-shadow:none }

    /* Right column - call history & settings */
    .side {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,0.02);
      height:560px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .side h4 { color:var(--muted); font-size:13px; font-weight:700; letter-spacing:0.8px }
    .history {
      background: rgba(255,255,255,0.03);
      border-radius:12px;padding:12px;flex:1;overflow:auto;border:1px solid rgba(255,255,255,0.02)
    }
    .entry { padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03); color:rgba(255,255,255,0.85); font-size:13px }
    .entry:last-child { border-bottom:none }
    .small { color:rgba(255,255,255,0.6); font-size:12px; margin-top:6px }

    /* responsive */
    @media (max-width:920px){
      .device { grid-template-columns: 1fr; }
      .side { height:auto; order:2 }
      .phone { order:1 }
    }
  </style>
</head>
<script>
const ivrOutput = document.getElementById("ivrOutput");
const keypad = document.getElementById("keypad");
const speaking = document.getElementById("speakingIndicator");
const statusText = document.getElementById("statusText");

let callActive = false;

async function startCall() {
  ivrOutput.innerHTML = "<p>ðŸ“ž Connecting to Air India IVR...</p>";
  statusText.textContent = "In Call";
  callActive = true;

  const res = await fetch("http://127.0.0.1:8000/ivr", { method: "POST" });
  const xml = await res.text();
  showMessage(parseIVR(xml));
  keypad.removeAttribute("aria-hidden");
}

function showMessage(text) {
  ivrOutput.innerHTML += `<p>${text}</p>`;
  ivrOutput.scrollTop = ivrOutput.scrollHeight;
}

function parseIVR(xml) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(xml, "text/xml");
  const say = doc.querySelector("Say");
  return say ? say.textContent : "No IVR message.";
}

async function pressKey(num) {
  if (!callActive) return;
  showMessage(`You pressed ${num}`);
  const formData = new FormData();
  formData.append("Digits", num);
  const res = await fetch("http://127.0.0.1:8000/handle-key", {
    method: "POST",
    body: formData,
  });
  const xml = await res.text();
  showMessage(parseIVR(xml));
}

document.querySelectorAll(".key").forEach(k => {
  k.addEventListener("click", () => pressKey(k.dataset.key));
});

const startBtn = document.createElement("button");
startBtn.textContent = "Start Call";
startBtn.className = "btn call";
startBtn.onclick = startCall;
document.querySelector(".actions")?.appendChild(startBtn);
</script>

<body>

  <div class="device">
    <!-- Left: Device (phone) -->
    <div class="phone" aria-live="polite">
      <div class="header">
        <div class="brand">
          <div class="logo">AI</div>
          <div>
            <div class="title">Air India â€” IVR Simulator</div>
            <div class="subtitle">Simulated call & DTMF flow</div>
          </div>
        </div>
        <div class="status-pill" aria-hidden="false">
          <div id="statusIcon" class="status-icon">ðŸ“ž</div>
          <div id="statusText" class="status-text">Ready to Call</div>
        </div>
      </div>

      <div class="screen">
        <div class="call-info">
          <div class="caller">
            <div class="caller-number">+91 1800-123-456</div>
            <div id="callDuration" class="call-duration">00:00</div>
          </div>
          <div class="speaker-box">
            <div class="speaker-emoji">ðŸŽ§</div>
          </div>
        </div>

        <div id="ivrOutput" class="ivr" aria-atomic="true">
          <p class="note">Press <strong>Start Call</strong> to begin...</p>
        </div>

        <div id="speakingIndicator" class="speaking hidden" aria-hidden="true">
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
          <div class="bar"></div>
        </div>

        <div class="controls">
          <div id="keypad" class="keypad" aria-hidden="true">
            <!-- keypad buttons (static for reliability) -->
            <div class="key" data-key="1"><div class="num">1</div><div class="letters"></div></div>
            <div class="key" data-key="2"><div class="num">2</div><div class="letters">ABC</div></div>
            <div class="key" data-key="3"><div class="num">3</div><div class="letters">DEF</div></div>

            <div class="key" data-key="4"><div class="num">4</div><div class="letters">GHI</div></div>
            <div class="key" data-key="5"><div class="num">5</div><div class="letters">JKL</div></div>
            <div class="key" data-key="6"><div class="num">6</div><div class="letters">MNO</div></div>

            <div class="key" data-key="7"><div class="num">7</div><div class="letters">PQRS</div></div>
            <div class="key" data-key="8"><div class="num">8</div><div class="letters">TUV</div></div>
            <div class="key" data-key="9"><div class="num">9</div><div class="letters">WXYZ</div></div>

            <div class="key" data-key="*"><div class="num">*</div><div class="letters"></div></div>
            <div class="key" data-key="0"><div class="num">0</div><div class="letters">+</div></div>
            <div class="key" data-key="#"><div class="num">#</div><div class="letters"></div></div>
          </div>

          <div class="actions">
            <button id="btnCall" class="btn call">ðŸ“ž Start Call</button>
            <button id="btnHangup" class="btn hang" disabled>ðŸ“µ Hang Up</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: side panel -->
    <aside class="side" aria-label="Call history and options">
      <h4>Call Log</h4>
      <div id="callHistory" class="history">
        <div class="entry">No calls yet</div>
      </div>
      <div class="small">Tip: Use keypad while call is active to navigate IVR. Press 9 to transfer to agent.</div>
    </aside>
  </div>

  <script>
    // IVR Simulator (modern, same behavior)
    (() => {
      // Elements
      const btnCall = document.getElementById('btnCall');
      const btnHang = document.getElementById('btnHangup');
      const keypad = document.getElementById('keypad');
      const keys = Array.from(document.querySelectorAll('.key'));
      const ivrOutput = document.getElementById('ivrOutput');
      const speakingIndicator = document.getElementById('speakingIndicator');
      const callHistory = document.getElementById('callHistory');
      const statusIcon = document.getElementById('statusIcon');
      const statusText = document.getElementById('statusText');
      const callDurationEl = document.getElementById('callDuration');

      // State
      let callActive = false;
      let callStart = null;
      let durationTimer = null;
      let currentMenu = 'main';
      let history = [];

      // WebAudio for DTMF beep (short tone)
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      function playBeep() {
        try {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = 'sine';
          o.frequency.value = 800; // single beep frequency (pleasant)
          g.gain.value = 0.02;
          o.connect(g); g.connect(audioCtx.destination);
          o.start();
          setTimeout(() => { o.stop(); }, 120);
        } catch (e) {
          // ignore if audio not allowed
          // console.warn('Audio not available', e);
        }
      }

      // Utilities
      const wait = ms => new Promise(r => setTimeout(r, ms));

      function appendIVR(text, opts={className:''}) {
        const p = document.createElement('p');
        if (opts.className) p.className = opts.className;
        p.textContent = text;
        ivrOutput.appendChild(p);
        ivrOutput.scrollTop = ivrOutput.scrollHeight;
      }

      function addLog(type, status) {
        const time = new Date().toLocaleTimeString();
        history.unshift(`${time} - ${type} - ${status}`);
        renderHistory();
      }
      function renderHistory(){
        if (history.length === 0) {
          callHistory.innerHTML = '<div class="entry">No calls yet</div>';
          return;
        }
        callHistory.innerHTML = history.slice(0, 20).map(h => `<div class="entry">${h}</div>`).join('');
      }

      // Duration
      function startDuration(){
        callStart = Date.now();
        durationTimer = setInterval(() => {
          const s = Math.floor((Date.now() - callStart)/1000);
          const m = String(Math.floor(s/60)).padStart(2, '0');
          const sec = String(s % 60).padStart(2, '0');
          callDurationEl.textContent = `${m}:${sec}`;
        }, 1000);
      }
      function stopDuration(){ clearInterval(durationTimer); durationTimer = null; }

      // UI toggles
      function enableKeypad(enabled){
        keys.forEach(k => {
          if (enabled) k.classList.remove('disabled');
          else k.classList.add('disabled');
        });
        keypad.setAttribute('aria-hidden', !enabled);
      }
      function setStatus(icon, text){
        statusIcon.textContent = icon;
        statusText.textContent = text;
      }

      // Speaking visual + pseudo-speech
      async function speakText(text){
        // show speaking bars
        speakingIndicator.classList.remove('hidden');
        speakingIndicator.setAttribute('aria-hidden','false');

        appendIVR('ðŸ”Š ' + text);
        // duration simulation: ~45-60ms per char (similar to original 50ms)
        const dur = Math.max(500, text.length * 45);
        await wait(dur);

        speakingIndicator.classList.add('hidden');
        speakingIndicator.setAttribute('aria-hidden','true');
      }

      // IVR flow functions (preserve original messages & logic)
      async function playWelcome(){
        await speakText("Welcome to Air India Airlines Customer Support.");
        await wait(500);
        await speakText("Press 1 for Booking Enquiry.");
        await wait(300);
        await speakText("Press 2 for Flight Status.");
        await wait(300);
        await speakText("Press 9 to speak with an agent.");
      }

      async function handleMain(digit){
        if (digit === '1') {
          currentMenu = 'booking';
          await speakText("You selected Booking Enquiry.");
          await wait(500);
          await speakText("Press 1 for Domestic Flights.");
          await wait(300);
          await speakText("Press 2 for International Flights.");
          await wait(300);
          await speakText("Press 0 to go back to main menu.");
        } else if (digit === '2') {
          await speakText("You selected Flight Status.");
          await wait(500);
          await speakText("Please enter your 6-digit PNR number followed by hash.");
        } else if (digit === '9') {
          await speakText("Transferring you to an agent. Please hold.");
          await wait(2000);
          // end call after transfer
          endCall();
        } else {
          await speakText("Sorry, that was not a valid option. Please try again.");
        }
      }

      async function handleBooking(digit){
        if (digit === '1') {
          await speakText("You selected Domestic Flights.");
          await wait(500);
          await speakText("Our team will call you back within 5 minutes.");
          await wait(500);
          await speakText("Thank you for calling Air India. Goodbye.");
          await wait(1000);
          endCall();
        } else if (digit === '2') {
          await speakText("You selected International Flights.");
          await wait(500);
          await speakText("Please visit our website airindia.com for international bookings.");
          await wait(500);
          await speakText("Thank you. Goodbye.");
          await wait(1000);
          endCall();
        } else if (digit === '0') {
          currentMenu = 'main';
          await playWelcome();
        } else {
          await speakText("Invalid option. Please try again.");
        }
      }

      // handle key press
      async function onKeyPress(d) {
        if (!callActive) return;
        playBeep();
        appendIVR(`[You pressed: ${d}]`, {className:''});
        if (currentMenu === 'main') await handleMain(d);
        else if (currentMenu === 'booking') await handleBooking(d);
      }

      // start call
      async function startCall(){
        if (callActive) return;
        // resume audio context on user gesture (some browsers require)
        if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
        callActive = true;
        setStatus('ðŸ“ž','Call Connected');
        btnCall.disabled = true;
        btnHang.disabled = false;
        enableKeypad(true);
        ivrOutput.innerHTML = '';
        startDuration();
        addLog('Outgoing','Connected');
        currentMenu = 'main';
        await playWelcome();
      }

      // end call
      function endCall(){
        if (!callActive) return;
        callActive = false;
        setStatus('ðŸ“µ','Call Ended');
        btnCall.disabled = false;
        btnHang.disabled = true;
        enableKeypad(false);
        stopDuration();
        const totalSec = Math.floor((Date.now() - callStart)/1000);
        addLog('Outgoing', `Ended (${totalSec}s)`);
        // show final text then reset UI after brief delay
        setTimeout(() => {
          setStatus('ðŸ“ž','Ready to Call');
          callDurationEl.textContent = '00:00';
          ivrOutput.innerHTML = `<p class="note">Press <strong>Start Call</strong> to begin...</p>`;
          currentMenu = 'main';
        }, 1600);
      }

      // Wire events
      btnCall.addEventListener('click', async () => {
        // set start timestamp
        callStart = Date.now();
        await startCall();
      });
      btnHang.addEventListener('click', endCall);

      keys.forEach(k => {
        k.addEventListener('click', () => {
          const d = k.getAttribute('data-key');
          onKeyPress(d);
        });
      });

      // initialize UI
      enableKeypad(false);
      renderHistory();

      // keyboard support (optional)
      window.addEventListener('keydown', (ev) => {
        const key = ev.key;
        const valid = ['0','1','2','3','4','5','6','7','8','9','*','#'];
        if (valid.includes(key)) {
          // visually flash key
          const el = keys.find(x => x.dataset.key === key);
          if (el) {
            el.animate([{transform:'scale(1)'},{transform:'scale(0.98)'},{transform:'scale(1)'}], {duration:150});
          }
          onKeyPress(key);
        } else if (key === 'Enter') {
          if (!callActive) btnCall.click();
        } else if (key === 'Escape') {
          if (callActive) btnHang.click();
        }
      });

    })();
  </script>
</body>
</html>
